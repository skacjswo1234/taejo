<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>관리자 대시보드</title>
  <link rel="stylesheet" href="styles-admin.css">
</head>
<body class="admin-page">
  <header class="admin-header">
    <div class="admin-header__left">
      <img src="images/taejo-logo.png" alt="태조 로고" class="admin-logo">
      <span class="admin-header__title">관리자</span>
    </div>
    <button id="mobile-menu-btn" class="admin-header__menu-btn" aria-label="메뉴 열기">
      ☰
    </button>
  </header>

  <div class="admin-layout">
    <nav id="admin-nav" class="admin-nav">
      <div class="admin-nav__logo">
        <img src="images/taejo-logo.png" alt="태조 로고">
      </div>
      <ul class="admin-nav__list">
        <li><a href="#dashboard" data-section="dashboard" class="active">대시보드</a></li>
        <li><a href="#inquiries" data-section="inquiries">문의 관리</a></li>
        <li><a href="#password" data-section="password">비밀번호 변경</a></li>
      </ul>
      <button id="logout-btn" class="admin-nav__logout">로그아웃</button>
    </nav>

    <main class="admin-main">
      <!-- 대시보드 -->
      <section id="dashboard" class="admin-section active">
        <h2>대시보드</h2>
        <p>관리자 메뉴를 선택하세요.</p>
      </section>

      <!-- 문의 관리 -->
      <section id="inquiries" class="admin-section">
        <div class="admin-section__header">
          <h2>문의 관리</h2>
          <div class="admin-filters">
            <input type="text" id="search-input" class="admin-filter__input" placeholder="이름, 전화, 제목, 내용 검색...">
            <select id="status-filter" class="admin-filter__select">
              <option value="">전체 상태</option>
              <option value="new">신규</option>
              <option value="read">읽음</option>
              <option value="processing">처리중</option>
              <option value="completed">완료</option>
            </select>
            <button id="search-btn" class="admin-filter__button">조회</button>
          </div>
        </div>
        <div id="inquiries-status" class="admin-form__status"></div>
        <div class="admin-table-wrapper">
          <table class="admin-table" id="inquiries-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>이름</th>
                <th>전화</th>
                <th>유형</th>
                <th>제목</th>
                <th>상태</th>
                <th>작성시각</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="7" style="text-align:center;">불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 비밀번호 변경 -->
      <section id="password" class="admin-section">
        <h2>비밀번호 변경</h2>
        <form id="password-form" class="admin-form">
          <label class="admin-form__label" for="currentPassword">현재 비밀번호</label>
          <input type="password" id="currentPassword" name="currentPassword" class="admin-form__input" required>

          <label class="admin-form__label" for="newPassword">새 비밀번호</label>
          <input type="password" id="newPassword" name="newPassword" class="admin-form__input" required>

          <button type="submit" class="admin-form__button">변경하기</button>
          <p id="password-status" class="admin-form__status"></p>
        </form>
      </section>
    </main>
  </div>

  <!-- 상세 모달 -->
  <div id="detail-modal" class="admin-modal">
    <div class="admin-modal__content">
      <div class="admin-modal__header">
        <h3>문의 상세</h3>
        <button id="close-modal" class="admin-modal__close">×</button>
      </div>
      <div class="admin-modal__body" id="modal-body">
        <!-- 동적으로 채워짐 -->
      </div>
    </div>
  </div>

  <div id="nav-overlay" class="admin-nav-overlay"></div>

  <script>
    (function() {
      // 인증 체크
      if (sessionStorage.getItem('adminAuthed') !== 'true') {
        window.location.href = 'admin-login.html';
        return;
      }

      const mobileBtn = document.getElementById('mobile-menu-btn');
      const nav = document.getElementById('admin-nav');
      const overlay = document.getElementById('nav-overlay');
      const logoutBtn = document.getElementById('logout-btn');
      const passwordForm = document.getElementById('password-form');
      const passwordStatus = document.getElementById('password-status');
      const inquiriesStatus = document.getElementById('inquiries-status');
      const inquiriesTable = document.getElementById('inquiries-table').querySelector('tbody');
      const searchInput = document.getElementById('search-input');
      const statusFilter = document.getElementById('status-filter');
      const searchBtn = document.getElementById('search-btn');
      const detailModal = document.getElementById('detail-modal');
      const closeModal = document.getElementById('close-modal');
      const modalBody = document.getElementById('modal-body');

      let allInquiries = [];

      // 섹션 전환
      const sections = document.querySelectorAll('.admin-section');
      const navLinks = document.querySelectorAll('.admin-nav__list a');

      function showSection(targetId) {
        sections.forEach(s => s.classList.remove('active'));
        navLinks.forEach(link => link.classList.remove('active'));
        const target = document.getElementById(targetId);
        if (target) target.classList.add('active');
        const activeLink = document.querySelector(`[data-section="${targetId}"]`);
        if (activeLink) activeLink.classList.add('active');
        
        // 모바일 메뉴 닫기
        closeMenu();
      }

      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const sectionId = link.getAttribute('data-section');
          if (sectionId) showSection(sectionId);
        });
      });

      // 모바일 메뉴
      const closeMenu = () => {
        nav.classList.remove('open');
        overlay.classList.remove('show');
      };
      const openMenu = () => {
        nav.classList.add('open');
        overlay.classList.add('show');
      };

      mobileBtn.addEventListener('click', openMenu);
      overlay.addEventListener('click', closeMenu);

      // 로그아웃
      logoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem('adminAuthed');
        window.location.href = 'admin-login.html';
      });

      // 문의 목록 로드
      async function loadInquiries() {
        const search = searchInput.value.trim();
        const status = statusFilter.value;
        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (status) params.append('status', status);

        inquiriesStatus.textContent = '문의 목록을 불러오는 중...';
        inquiriesStatus.className = 'admin-form__status';
        inquiriesTable.innerHTML = '<tr><td colspan="7" style="text-align:center;">불러오는 중...</td></tr>';

        try {
          const url = `/api/admin-inquiries${params.toString() ? '?' + params.toString() : ''}`;
          const res = await fetch(url);
          const data = await res.json().catch(() => ({}));
          
          if (!res.ok || !data.ok) {
            inquiriesStatus.textContent = data.error || '불러오기에 실패했습니다.';
            inquiriesStatus.classList.add('error');
            inquiriesTable.innerHTML = '<tr><td colspan="7" style="text-align:center;">오류 발생</td></tr>';
            return;
          }

          allInquiries = data.items || [];
          
          if (!allInquiries.length) {
            inquiriesTable.innerHTML = '<tr><td colspan="7" style="text-align:center;">데이터가 없습니다.</td></tr>';
            inquiriesStatus.textContent = '';
            return;
          }

          const statusMap = {
            'new': '신규',
            'read': '읽음',
            'processing': '처리중',
            'completed': '완료'
          };

          const rows = allInquiries.map(item => {
            const statusText = statusMap[item.status] || item.status || '신규';
            const statusClass = item.status || 'new';
            return `
              <tr class="admin-table__row" data-id="${item.id}">
                <td>${item.id}</td>
                <td>${item.name || ''}</td>
                <td>${item.phone || ''}</td>
                <td>${item.inquiry_type || ''}</td>
                <td class="admin-table__subject">${(item.subject || '').substring(0, 30)}${(item.subject || '').length > 30 ? '...' : ''}</td>
                <td><span class="admin-status admin-status--${statusClass}">${statusText}</span></td>
                <td>${item.created_at ? new Date(item.created_at).toLocaleString('ko-KR') : ''}</td>
              </tr>
            `;
          }).join('');

          inquiriesTable.innerHTML = rows;
          inquiriesStatus.textContent = `총 ${allInquiries.length}건`;

          // 행 클릭 이벤트
          document.querySelectorAll('.admin-table__row').forEach(row => {
            row.style.cursor = 'pointer';
            row.addEventListener('click', () => {
              const id = parseInt(row.getAttribute('data-id'));
              showDetailModal(id);
            });
          });
        } catch (err) {
          inquiriesStatus.textContent = '네트워크 오류가 발생했습니다.';
          inquiriesStatus.classList.add('error');
          inquiriesTable.innerHTML = '<tr><td colspan="7" style="text-align:center;">오류 발생</td></tr>';
        }
      }

      // 상세 모달 표시
      function showDetailModal(id) {
        const item = allInquiries.find(i => i.id === id);
        if (!item) return;

        const statusMap = {
          'new': '신규',
          'read': '읽음',
          'processing': '처리중',
          'completed': '완료'
        };

        modalBody.innerHTML = `
          <div class="admin-modal__field">
            <label>ID</label>
            <div>${item.id}</div>
          </div>
          <div class="admin-modal__field">
            <label>이름</label>
            <div>${item.name || ''}</div>
          </div>
          <div class="admin-modal__field">
            <label>전화번호</label>
            <div>${item.phone || '-'}</div>
          </div>
          <div class="admin-modal__field">
            <label>문의 유형</label>
            <div>${item.inquiry_type || ''}</div>
          </div>
          <div class="admin-modal__field">
            <label>제목</label>
            <div>${item.subject || ''}</div>
          </div>
          <div class="admin-modal__field">
            <label>문의 내용</label>
            <div class="admin-modal__message">${(item.message || '').replace(/\n/g, '<br>')}</div>
          </div>
          <div class="admin-modal__field">
            <label>개인정보 동의</label>
            <div>${item.privacy ? '동의' : '미동의'}</div>
          </div>
          <div class="admin-modal__field">
            <label>상태</label>
            <div><span class="admin-status admin-status--${item.status || 'new'}">${statusMap[item.status] || '신규'}</span></div>
          </div>
          <div class="admin-modal__field">
            <label>작성시각</label>
            <div>${item.created_at ? new Date(item.created_at).toLocaleString('ko-KR') : ''}</div>
          </div>
        `;

        detailModal.classList.add('show');
      }

      // 모달 닫기
      closeModal.addEventListener('click', () => {
        detailModal.classList.remove('show');
      });
      detailModal.addEventListener('click', (e) => {
        if (e.target === detailModal) {
          detailModal.classList.remove('show');
        }
      });

      // 검색/조회
      searchBtn.addEventListener('click', loadInquiries);
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadInquiries();
      });

      // 비밀번호 변경
      passwordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const currentPassword = passwordForm.currentPassword.value.trim();
        const newPassword = passwordForm.newPassword.value.trim();
        passwordStatus.textContent = '변경 중...';
        passwordStatus.className = 'admin-form__status';

        try {
          const res = await fetch('/api/admin-password', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ currentPassword, newPassword })
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.ok) {
            passwordStatus.textContent = '비밀번호가 변경되었습니다.';
            passwordForm.reset();
          } else {
            passwordStatus.textContent = data.error || '변경에 실패했습니다.';
            passwordStatus.classList.add('error');
          }
        } catch (err) {
          passwordStatus.textContent = '네트워크 오류가 발생했습니다.';
          passwordStatus.classList.add('error');
        }
      });

      // 초기 로드
      loadInquiries();
    })();
  </script>
</body>
</html>
