<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>관리자 대시보드</title>
  <link rel="stylesheet" href="styles-admin.css">
</head>
<body class="admin-page">
  <header class="admin-header">
    <div class="admin-header__left">
      <img src="images/taejo-logo.png" alt="태조 로고" class="admin-logo">
      <span class="admin-header__title">관리자</span>
    </div>
    <button id="mobile-menu-btn" class="admin-header__menu-btn" aria-label="메뉴 열기">
      ☰
    </button>
  </header>

  <div class="admin-layout">
    <nav id="admin-nav" class="admin-nav">
      <div class="admin-nav__logo">
        <img src="images/taejo-logo.png" alt="태조 로고">
      </div>
      <ul class="admin-nav__list">
        <li><a href="#dashboard" class="active">대시보드</a></li>
        <li><a href="#inquiries">문의 관리</a></li>
        <li><a href="#password">비밀번호 변경</a></li>
      </ul>
      <button id="logout-btn" class="admin-nav__logout">로그아웃</button>
    </nav>

    <main class="admin-main">
      <section id="dashboard" class="admin-section">
        <h2>대시보드</h2>
        <p>관리자 메뉴를 선택하세요.</p>
      </section>

      <section id="inquiries" class="admin-section">
        <h2>문의 관리</h2>
        <div id="inquiries-status" class="admin-form__status"></div>
        <div class="admin-table-wrapper">
          <table class="admin-table" id="inquiries-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>이름</th>
                <th>전화</th>
                <th>유형</th>
                <th>제목</th>
                <th>내용</th>
                <th>동의</th>
                <th>작성시각</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8" style="text-align:center;">불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section id="password" class="admin-section">
        <h2>비밀번호 변경</h2>
        <form id="password-form" class="admin-form">
          <label class="admin-form__label" for="currentPassword">현재 비밀번호</label>
          <input type="password" id="currentPassword" name="currentPassword" class="admin-form__input" required>

          <label class="admin-form__label" for="newPassword">새 비밀번호</label>
          <input type="password" id="newPassword" name="newPassword" class="admin-form__input" required>

          <button type="submit" class="admin-form__button">변경하기</button>
          <p id="password-status" class="admin-form__status"></p>
        </form>
      </section>
    </main>
  </div>

  <div id="nav-overlay" class="admin-nav-overlay"></div>

  <script>
    (function() {
      // 인증 체크 (단순 플래그)
      if (sessionStorage.getItem('adminAuthed') !== 'true') {
        window.location.href = 'admin-login.html';
        return;
      }

      const mobileBtn = document.getElementById('mobile-menu-btn');
      const nav = document.getElementById('admin-nav');
      const overlay = document.getElementById('nav-overlay');
      const logoutBtn = document.getElementById('logout-btn');
      const form = document.getElementById('password-form');
      const statusEl = document.getElementById('password-status');
      const inquiriesStatus = document.getElementById('inquiries-status');
      const inquiriesTable = document.getElementById('inquiries-table').querySelector('tbody');

      const closeMenu = () => {
        nav.classList.remove('open');
        overlay.classList.remove('show');
      };
      const openMenu = () => {
        nav.classList.add('open');
        overlay.classList.add('show');
      };

      mobileBtn.addEventListener('click', openMenu);
      overlay.addEventListener('click', closeMenu);

      logoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem('adminAuthed');
        window.location.href = 'admin-login.html';
      });

      async function loadInquiries() {
        inquiriesStatus.textContent = '문의 목록을 불러오는 중...';
        inquiriesStatus.className = 'admin-form__status';
        inquiriesTable.innerHTML = '<tr><td colspan="8" style="text-align:center;">불러오는 중...</td></tr>';
        try {
          const res = await fetch('/api/admin-inquiries');
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.ok) {
            inquiriesStatus.textContent = data.error || '불러오기에 실패했습니다.';
            inquiriesStatus.classList.add('error');
            return;
          }
          const items = data.items || [];
          if (!items.length) {
            inquiriesTable.innerHTML = '<tr><td colspan="8" style="text-align:center;">데이터가 없습니다.</td></tr>';
            inquiriesStatus.textContent = '';
            return;
          }
          const rows = items.map(item => {
            const privacy = item.privacy ? '동의' : '미동의';
            return `
              <tr>
                <td>${item.id}</td>
                <td>${item.name || ''}</td>
                <td>${item.phone || ''}</td>
                <td>${item.inquiry_type || ''}</td>
                <td>${item.subject || ''}</td>
                <td class="admin-table__message">${(item.message || '').replace(/</g,'&lt;')}</td>
                <td>${privacy}</td>
                <td>${item.created_at || ''}</td>
              </tr>
            `;
          }).join('');
          inquiriesTable.innerHTML = rows;
          inquiriesStatus.textContent = '';
        } catch (err) {
          inquiriesStatus.textContent = '네트워크 오류가 발생했습니다.';
          inquiriesStatus.classList.add('error');
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const currentPassword = form.currentPassword.value.trim();
        const newPassword = form.newPassword.value.trim();
        statusEl.textContent = '변경 중...';
        statusEl.className = 'admin-form__status';

        try {
          const res = await fetch('/api/admin-password', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ currentPassword, newPassword })
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.ok) {
            statusEl.textContent = '비밀번호가 변경되었습니다.';
            form.reset();
          } else {
            statusEl.textContent = data.error || '변경에 실패했습니다.';
            statusEl.classList.add('error');
          }
        } catch (err) {
          statusEl.textContent = '네트워크 오류가 발생했습니다.';
          statusEl.classList.add('error');
        }
      });

      loadInquiries();
    })();
  </script>
</body>
</html>

